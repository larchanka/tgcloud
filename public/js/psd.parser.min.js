/** @license psd.js 2012 - imaya [ https://github.com/imaya/psd.js ] The MIT License */
(function() {'use strict';function e(){return function(){}}var i=this;function j(a,b){var c=a.split("."),d=i;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var f;c.length&&(f=c.shift());)!c.length&&void 0!==b?d[f]=b:d=d[f]?d[f]:d[f]={}}function l(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};var m=void 0!==i.Uint8Array&&void 0!==i.Uint16Array&&void 0!==i.Uint32Array;function n(){}n.prototype.parse=function(a,b){var c;this.offset=a.ip;this.signature=p(a,4);this.key=p(a,4);c=r(a);this.length=c+12;"function"===typeof n[this.key]?(this.info=new n[this.key],this.info.parse(a,c,b)):i.console.warn("additional layer information: not implemented",this.key);a.seek(this.offset+this.length,0)};var u={};u.bevl={};u.bevl=e();
u.bevl.prototype.parse=function(a){this.offset=a.ip;this.size=r(a);this.version=r(a);this.angle=v(a);this.strength=v(a);this.blur=v(a);this.highlightBlendModeSignature=p(a,4);this.highlightBlendModeKey=p(a,4);this.shadowBlendModeSignature=p(a,4);this.shadowBlendModeKey=p(a,4);a.seek(2);this.highlightColor=[r(a),r(a)];a.seek(2);this.shadowColor=[r(a),r(a)];this.bevelStyle=z(a);this.highlightOpacity=z(a);this.shadowOpacity=z(a);this.enabled=!!z(a);this.use=!!z(a);this.up=!!z(a);2===this.version&&(a.seek(2),
this.readHighlightColor=[r(a),r(a)],a.seek(2),this.readShadowColor=[r(a),r(a)]);this.length=a.ip-this.offset};u.cmnS={};u.cmnS=e();u.cmnS.prototype.parse=function(a){this.offset=a.ip;this.size=r(a);this.version=r(a);this.visible=!!z(a);a.seek(2);this.length=a.ip-this.offset};u.dsdw={};u.dsdw=e();u.dsdw.prototype.parse=function(a){this.offset=a.ip;this.size=r(a);this.version=r(a);this.blur=v(a);this.intensity=v(a);this.angle=v(a);this.distance=v(a);a.seek(2);this.color=[r(a),r(a)];this.signature=p(a,4);this.blend=p(a,4);this.enabled=!!z(a);this.use=!!z(a);this.opacity=z(a);a.seek(2);this.nativeColor=[r(a),r(a)];this.length=a.ip-this.offset};u.iglw={};u.iglw=e();u.iglw.prototype.parse=function(a){this.offset=a.ip;this.size=r(a);this.version=r(a);this.blur=v(a);this.intensity=v(a);a.seek(2);this.color=[r(a),r(a)];this.signature=p(a,4);this.blend=p(a,4);this.enabled=!!z(a);this.opacity=z(a);2===this.version&&(this.invert=!!z(a),a.seek(2),this.nativeColor=[r(a),r(a)]);this.length=a.ip-this.offset};u.isdw={};u.isdw=u.dsdw;u.oglw={};u.oglw=e();u.oglw.prototype.parse=function(a){this.offset=a.ip;this.size=r(a);this.version=r(a);this.blur=v(a);this.intensity=v(a);a.seek(2);this.color=[r(a),r(a)];this.signature=p(a,4);this.blend=p(a,4);this.enabled=!!z(a);this.opacity=z(a);2===this.version&&(a.seek(2),this.nativeColor=[r(a),r(a)]);this.length=a.ip-this.offset};u.sofi={};u.sofi=e();u.sofi.prototype.parse=function(a){var b;this.offset=a.ip;this.size=r(a);this.version=r(a);b=p(a,4);if("8BIM"!==b)throw Error("invalid signature:",b);this.blend=p(a,4);a.seek(2);this.color=[A(a)>>8,A(a)>>8,A(a)>>8,A(a)>>8];this.opacity=z(a);this.enabled=!!z(a);a.seek(2);this.nativeColor=[B(a)>>8,B(a)>>8,B(a)>>8,B(a)>>8];this.length=a.ip-this.offset};n.Patt=e();n.Patt.prototype.parse=function(a,b,c){b=a.ip+b;for(this.offset=a.ip;a.ip<b;)r(a),r(a),v(a),B(a),B(a),D(a,r(a)),p(a,a.input[a.ip++]),c.colorMode===E&&F(a,768),F(a,b-this.offset);this.length=a.ip-this.offset};n.PlLd=e();
n.PlLd.prototype.parse=function(a){this.offset=a.ip;this.type=p(a,4);if("plcL"!==this.type)throw Error("invalid type:",this.type);this.version=r(a);this.id=p(a,a.input[a.ip++]);this.page=v(a);this.totalPage=v(a);this.antiAlias=v(a);this.placedLayerType=v(a);this.transform=[a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()];this.warpVersion=v(a);this.warpDescriptorVersion=v(a);this.descriptor=new G;this.descriptor.parse(a);this.length=
a.ip-this.offset};n.SoLd=e();n.SoLd.prototype.parse=function(a){this.offset=a.ip;this.identifier=p(a,4);if("soLD"!==this.identifier)throw Error("invalid identifier:",this.identifier);this.version=r(a);this.descriptorVersion=v(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.TySh=e();
n.TySh.prototype.parse=function(a){this.offset=a.ip;this.version=B(a);this.transform=[a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()];this.textVersion=B(a);this.textDescriptorVersion=v(a);this.textData=new G;this.textData.parse(a);this.textData.items!==this.textData.item.length?i.console.error("Descriptor parsing failed"):(this.warpVersion=B(a),this.warpDescriptorVersion=v(a),this.warpData=new G,this.warpData.parse(a),i.console.log("TySh implementation is incomplete"),this.left=
v(a),this.top=v(a),this.right=v(a),this.bottom=v(a),this.length=a.ip-this.offset)};n.clbl=e();n.clbl.prototype.parse=function(a){this.offset=a.ip;this.blendClippedElements=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.fxrp=e();n.fxrp.prototype.parse=function(a){this.offset=a.ip;this.referencePoint=[a.readFloat64(),a.readFloat64()];this.length=a.ip-this.offset};n.iOpa=e();n.iOpa.prototype.parse=function(a){this.offset=a.ip;this.opacity=z(a);a.seek(3);this.length=a.ip-this.offset};n.infx=e();n.infx.prototype.parse=function(a){this.offset=a.ip;this.blendInteriorElements=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.knko=e();n.knko.prototype.parse=function(a){this.offset=a.ip;this.knockout=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.lclr=e();n.lclr.prototype.parse=function(a){this.offset=a.ip;this.color=[r(a),r(a)];this.length=a.ip-this.offset};n.lfx2=e();n.lfx2.prototype.parse=function(a){this.offset=a.ip;this.version=r(a);this.descriptorVersion=r(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.lnsr=e();n.lnsr.prototype.parse=function(a){this.offset=a.ip;this.id=p(a,4);this.length=a.ip-this.offset};n.lrFX=e();n.lrFX.prototype.parse=function(a){var b,c,d;this.offset=a.ip;this.version=A(a);this.count=A(a);this.effect=[];for(d=0;d<this.count;++d){b=p(a,4);if("8BIM"!==b){i.console.warn("invalid signature:",b);break}this.key=b=p(a,4);if("function"===typeof u[this.key])c=new u[this.key],c.parse(a),this.effect[d]={key:b,effect:c};else{i.console.warn("detect unknown key:",b);break}}this.length=a.ip-this.offset};n.lsct=e();n.lsct.prototype.parse=function(a,b){var c;this.offset=a.ip;this.type=r(a);if(12===b){c=p(a,4);if("8BIM"!==c)throw Error("invalid section divider setting signature:",c);this.key=p(a,4)}this.length=a.ip-this.offset};n.lspf=e();n.lspf.prototype.parse=function(a){this.offset=a.ip;this.flags=r(a);this.length=a.ip-this.offset};n.luni=e();n.luni.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.layerName=D(a,b);1===(b&1)&&a.seek(2);this.length=a.ip-this.offset};n.lyid=e();n.lyid.prototype.parse=function(a){this.offset=a.ip;this.layerId=r(a);this.length=a.ip-this.offset};n.lyvr=e();n.lyvr.prototype.parse=function(a){this.offset=a.ip;this.version=r(a);this.length=a.ip-this.offset};n.shmd=e();n.shmd.prototype.parse=function(a){var b,c,d,f,g=this.metadata=[],k,h;this.offset=a.ip;this.items=r(a);k=0;for(h=this.items;k<h;++k)b=p(a,4),c=p(a,4),d=z(a),a.seek(3),f=r(a),f=F(a,f),g[k]={signature:b,key:c,copy:d,data:f};this.length=a.ip-this.offset};n.vmsk=e();n.vmsk.prototype.parse=function(a,b){var c=a.ip+b;this.offset=a.ip;this.version=r(a);for(this.flags=r(a);a.ip+26<=c;)this.path=new H,this.path.parse(a);this.length=a.ip-this.offset};function I(){};function G(){}G.prototype.parse=function(a){var b,c,d,f;this.offset=a.ip;b=r(a);this.name=D(a,b);b=r(a)||4;this.classId=p(a,b);this.items=r(a);this.item=[];d=0;for(f=this.items;d<f;++d){b=r(a)||4;b=p(a,b);c=p(a,4);if("function"!==typeof G[c]){i.console.warn("OSType Key not implemented:",c);break}c=new G[c];c.parse(a);this.item.push({key:b,data:c})}this.length=a.ip-this.offset};n.GdFl=e();n.GdFl.prototype.parse=function(a){this.offset=a.ip;this.version=r(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.SoCo=e();n.SoCo.prototype.parse=function(a){this.offset=a.ip;this.version=r(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};G.ObAr=e();G.ObAr.prototype.parse=function(a){this.offset=a.ip;i.console.warn("OSType key not implemented (undocumented): ObAr(ObjectArray?)");this.length=a.ip-this.offset};G.Objc=e();G.Objc.prototype.parse=function(a){this.offset=a.ip;this.value=new G;this.value.parse(a);this.length=a.ip-this.offset};G.GlbO=G.Objc;G.TEXT=e();G.TEXT.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.string=D(a,b);this.length=a.ip-this.offset};G.UnFl=e();G.UnFl.prototype.parse=function(a){var b=this.value=[],c,d;this.offset=a.ip;this.key=p(a,4);c=r(a);for(d=0;d<c;++d)b[d]=a.readFloat64();this.length=a.ip-this.offset};G.UntF=e();G.UntF.prototype.parse=function(a){this.offset=a.ip;this.units=p(a,4);this.value=a.readFloat64();this.length=a.ip-this.offset};G.VlLs=e();G.VlLs.prototype.parse=function(a){var b,c,d,f;this.offset=a.ip;this.item=[];b=r(a);for(c=0;c<b;++c){d=p(a,4);if("function"!==typeof G[d]){i.console.error("OSType Key not implemented:",d);return}f=new G[d];f.parse(a);this.item.push({type:d,data:f})}this.length=a.ip-this.offset};G.alis=e();G.alis.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.value=F(a,b);this.length=a.ip-this.offset};G.bool=e();G.bool.prototype.parse=function(a){this.offset=a.ip;this.value=!!z(a);this.length=a.ip-this.offset};G.doub=e();G.doub.prototype.parse=function(a){this.offset=a.ip;this.value=a.readFloat64();this.length=a.ip-this.offset};G["enum"]=e();G["enum"].prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);0===b&&(b=4);this.type=p(a,b);b=r(a);0===b&&(b=4);this.enum=p(a,b);this.length=a.ip-this.offset};G["long"]=e();G["long"].prototype.parse=function(a){this.offset=a.ip;this.value=v(a);this.length=a.ip-this.offset};G["obj "]=e();G["obj "].prototype.parse=function(a){var b,c,d,f;this.offset=a.ip;this.item=[];b=this.items=r(a);for(f=0;f<b;++f){c=p(a,4);d=G["obj "].Table[c];if("function"!==typeof G[d]){i.console.error("OSType Key not implemented:",d);return}d=new G[d];d.parse(a);this.item.push({key:c,data:d})}this.length=a.ip-this.offset};G["obj "].Table={prop:"prop",Clss:"type",Enmr:"enum",rele:"rele",Idnt:"long",indx:"long",name:"TEXT"};G.prop=e();G.prop.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.name=D(a,b);b=r(a)||4;this.classId=p(a,b);b=r(a)||4;this.keyId=p(a,b);this.length=a.ip-this.offset};G.rele=e();G.rele.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.name=D(a,b);b=r(a)||4;this.classId=p(a,b);this.value=r(a);this.length=a.ip-this.offset};G.tdta=e();G.tdta.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.data=F(a,b);this.length=a.ip-this.offset};G.type=e();G.type.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.name=D(a,b);b=r(a)||4;this.classId=p(a,b);this.length=a.ip-this.offset};G.GlbC=G.type;var E=2;function J(){};function K(){this.channel=[]}K.prototype.parse=function(a){var b;this.offset=a.ip;this.length=r(a)+4;if(4===this.length)window.console.log("skip: layer blending ranges(empty body)");else{b=this.offset+this.length;this.black=A(a);this.white=A(a);for(this.destRange=r(a);a.ip<b;)this.channel.push([r(a),r(a)])}};function L(){}L.prototype.parse=function(a){var b;this.offset=a.ip;b=r(a);this.length=b+4;0===b?window.console.log("skip: layer mask data (empty body)"):(this.top=v(a),this.left=v(a),this.bottom=v(a),this.right=v(a),this.defaultColor=z(a),this.flags=z(a),20===b?this.padding=A(a):(this.realFlags=z(a),this.realBackground=z(a),this.top2=v(a),this.left2=v(a),this.bottom2=v(a),this.right2=v(a)))};function H(){}H.prototype.parse=function(a){this.offset=a.ip;this.type=B(a);a.seek(26,this.offset);this.length=a.ip-this.offset};function M(a,b){this.input=m?new Uint8Array(a):a;this.ip=b|0}function r(a){return(a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++])>>>0}function v(a){return a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++]}function A(a){return a.input[a.ip++]<<8|a.input[a.ip++]}function B(a){return(a.input[a.ip++]<<8|a.input[a.ip++])<<16>>16}function z(a){return a.input[a.ip++]}var aa=M.prototype;
if(m)var N=new ArrayBuffer(8),ba=new Uint8Array(N),ca=new Float64Array(N);else var da=Math.pow(2,48),ea=Math.pow(2,40),fa=Math.pow(2,32),ga=Math.pow(2,24),ha=Math.pow(2,16),ia=Math.pow(2,8),ja=Math.pow(2,-1022),ka=Math.pow(2,-52);
aa.readFloat64=function(){var a;if(m){a=this.input;for(var b=this.ip,c=8;--c;)ba[c]=a[b++];a=ca[0]}else{var c=this.input,d=this.ip;a=0===(c[d]&128);b=(c[d++]&127)<<4|(c[d]&240)>>4;c=(c[d++]&15)*da+c[d++]*ea+c[d++]*fa+c[d++]*ga+c[d++]*ha+c[d++]*ia+c[d++];a=0===b?0===c?0:(a?1:-1)*ja*c*ka:2047===b?c?NaN:a?Infinity:-Infinity:(a?1:-1)*(Math.pow(2,b-1023)+c*Math.pow(2,b-1075))}this.ip+=8;return a};function F(a,b){return m?a.input.subarray(a.ip,a.ip+=b):a.input.slice(a.ip,a.ip+=b)}
M.prototype.slice=function(a,b){this.ip=b;return m?this.input.subarray(a,b):this.input.slice(a,b)};M.prototype.fetch=function(a,b){return m?this.input.subarray(a,b):this.input.slice(a,b)};function p(a,b){var c=a.input,d=a.ip,f=[],g;for(g=0;g<b;++g)f[g]=String.fromCharCode(c[d++]);a.ip=d;return f.join("")}function D(a,b){var c=a.input,d=a.ip,f=[],g;for(g=0;g<b;++g)f[g]=String.fromCharCode(c[d++]<<8|c[d++]);a.ip=d;return f.join("")}
M.prototype.seek=function(a,b){"number"!==typeof b&&(b=this.ip);this.ip=b+a};function O(a,b){var c,d,f,g=[],k=0;for(c=a.ip+b;a.ip<c;)if(d=a.input[a.ip++]<<24>>24,0>d){d=1-d;for(f=z(a);0<d--;)g[k++]=f}else for(d=1+d;0<d--;)g[k++]=z(a);return g};function P(){}P.prototype.parse=function(a){this.offset=a.ip;this.length=r(a)+4;this.overlayColorSpace=A(a);this.colorComponents=[A(a),A(a),A(a),A(a)];this.opacity=A(a);this.kind=z(a);this.filter=F(a,this.offset+this.length-a.ip);a.seek(this.offset+this.length,0)};function Q(){}Q.prototype.parse=function(a){this.offset=a.ip;this.signature=p(a,4);if("8BPS"!==this.signature)throw Error("invalid signature");this.version=A(a);this.reserved=F(a,6);this.channels=A(a);this.rows=r(a);this.columns=r(a);this.depth=A(a);this.colorMode=A(a);this.length=a.ip-this.offset};function R(a,b,c){this.header=a;this.colorModeData=b;this.channel=c;this.parsed=!1}
R.prototype.parse=function(){switch(this.header.colorMode){case 0:window.console.error("bitmap color mode not supported");break;case 8:window.console.warn("duotone color mode implementation is incomplete");case 1:var a=this.channel[0],b,c=a.length,d=this.redChannel=new (m?Uint8Array:Array)(c),f=this.greenChannel=new (m?Uint8Array:Array)(c),g=this.blueChannel=new (m?Uint8Array:Array)(c),k=this.header.depth/8,h;for(b=h=0;b<c;++h,b+=k)d[h]=f[h]=g[h]=a[b];break;case E:a=this.channel[0];c=a.length;f=this.redChannel=
new (m?Uint8Array:Array)(c);g=this.greenChannel=new (m?Uint8Array:Array)(c);k=this.blueChannel=new (m?Uint8Array:Array)(c);h=this.colorModeData.data;var s=h.length/3;for(b=d=0;b<c;++d,b+=1)f[d]=h[a[b]],g[d]=h[a[b]+s],k[d]=h[a[b]+2*s];break;case 7:window.console.warn("multichannel color mode implementation is incomplete");case 3:a=this.redChannel=this.channel[0];b=this.greenChannel=this.channel[1];c=this.blueChannel=this.channel[2];f=this.header.depth/8;if(1!==f){if(4===this.channel.length){d=this.alphaChannel=
this.channel[3];g=h=0;for(k=a.length;g<k;++h,g+=f)a[h]=a[g],b[h]=b[g],c[h]=c[g],d[h]=d[g]}else{g=h=0;for(k=a.length;g<k;++h,g+=f)a[h]=a[g],b[h]=b[g],c[h]=c[g]}m?(this.redChannel=a.subarray(0,h),this.greenChannel=b.subarray(0,h),this.blueChannel=c.subarray(0,h)):a.length=b.length=c.length=h;4===this.channel.length&&(m?this.alphaChannel=d.subarray(0,h):d.length=h)}break;case 4:a=this.channel[0];b=this.channel[1];c=this.channel[2];d=this.channel[3];g=a.length;k=this.redChannel=new (m?Uint8Array:Array)(g);
h=this.greenChannel=new (m?Uint8Array:Array)(g);for(var s=this.blueChannel=new (m?Uint8Array:Array)(g),q,x,t,w,y=this.header.depth/8,C,f=C=0;f<g;++C,f+=y)q=255-a[f],x=255-b[f],t=255-c[f],w=255-d[f],k[C]=65535-(q*(255-w)+(w<<8))>>8,h[C]=65535-(x*(255-w)+(w<<8))>>8,s[C]=65535-(t*(255-w)+(w<<8))>>8;break;case 9:a=this.channel[0];b=this.channel[1];c=this.channel[2];f=a.length;g=this.redChannel=new (m?Uint8Array:Array)(f);k=this.greenChannel=new (m?Uint8Array:Array)(f);h=this.blueChannel=new (m?Uint8Array:
Array)(f);s=6/29;x=this.header.depth/8;for(d=q=0;d<f;++q,d+=x)y=((100*a[d]>>8)+16)/116,t=y+(b[d]-128)/500,w=y-(c[d]-128)/200,t=t>s?0.950456*Math.pow(t,3):3*(t-16/116)*Math.pow(s,2),y=y>s?1*Math.pow(y,3):3*(y-16/116)*Math.pow(s,2),w=w>s?1.088754*Math.pow(w,3):3*(w-16/116)*Math.pow(s,2),g[q]=255*Math.pow(2.041588*t-0.565007*y-0.344731*w,1/2.2),k[q]=255*Math.pow(-0.969244*t+1.875968*y+0.041555*w,1/2.2),h[q]=255*Math.pow(0.013444*t-0.118362*y+1.015175*w,1/2.2)}this.parsed=!0};function S(){}S.prototype.parse=function(a,b){var c;this.offset=a.ip;c=r(a);this.length=c+4;if(b.colorMode===E&&768!==c)throw Error("invalid color mode data");this.data=F(a,c)};function T(){}l(T,J);T.prototype.parse=function(a,b){var c=this.channel=[],d,f=b.channels,g=b.columns*b.rows*(b.depth/8);for(d=0;d<f;++d)c[d]=F(a,g)};function U(){}l(U,J);U.prototype.parse=function(a,b){var c,d=this.channel=[],f=this.lineLength=[],g,k,h=b.rows,s=b.channels,q;for(c=0;c<h*s;++c)f[c]=A(a);for(g=0;g<s;++g){k=[];for(c=q=0;c<h;++c)k[c]=O(a,f[g*h+c]*(b.depth/8)),q+=k[c].length;if(m){d[g]=new Uint8Array(q);q=c=0;for(h=k.length;c<h;++c)d[g].set(k[c],q),q+=k[c].length}else d[g]=Array.prototype.concat.apply([],k)}};function V(){}V.prototype.parse=function(a,b){this.offset=a.ip;this.compressionMethod=A(a);switch(this.compressionMethod){case 0:this.image=new T;break;case 1:this.image=new U;break;default:throw Error("unknown compression method");}this.image.parse(a,b);this.length=a.ip-this.offset};
V.prototype.createCanvas=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d"),f=c.width=a.columns,g=c.height=a.rows,k,h,s,q,x,t;k=new R(a,b,this.image.channel);k.parsed||k.parse();t=[k.redChannel,k.greenChannel,k.blueChannel];if(0>=f||0>=g)return null;k=d.createImageData(f,g);h=k.data;for(q=0;q<g;++q)for(s=0;s<f;++s)x=q*f+s,h[4*x]=t[0][x],h[4*x+1]=t[1][x],h[4*x+2]=t[2][x],h[4*x+3]=255;d.putImageData(k,0,0);return c};function W(){}W.prototype.parse=function(a){this.offset=a.ip;if("8BIM"!==p(a,4))throw Error("invalid signature");this.identifier=A(a);this.name=p(a,a.input[a.ip++]);this.dataSize=r(a);this.data=F(a,this.dataSize);this.length=a.ip-this.offset};function la(){}la.prototype.parse=function(a){this.offset=a.ip;this.length=r(a)+4;this.imageResource=new W;this.imageResource.parse(a);a.seek(this.offset+this.length,0)};function ma(){this.info=[]}
ma.prototype.parse=function(a,b){var c,d;this.offset=a.ip;this.top=v(a);this.left=v(a);this.bottom=v(a);this.right=v(a);this.channels=A(a);c=0;for(d=this.channels;c<d;++c)this.info[c]={id:B(a),length:r(a)};if("8BIM"!==p(a,4))throw Error("invalid blend mode signature");this.blendMode=p(a,4);this.opacity=z(a);this.clipping=z(a);this.flags=z(a);this.filter=z(a);this.extraLength=r(a);c=a.ip+this.extraLength;this.layerMaskData=new L;this.layerMaskData.parse(a);this.blendingRanges=new K;this.blendingRanges.parse(a);
d=z(a);this.name=p(a,d);a.seek((4-(1+d)%4)%4);for(this.additionalLayerInfo=[];a.ip<c;)d=new n,d.parse(a,b),this.additionalLayerInfo.push(d);this.length=a.ip-this.offset};function X(){}l(X,I);X.prototype.parse=function(a,b,c){this.channel=F(a,c)};function Y(){}l(Y,I);Y.prototype.parse=function(a,b,c){var d=this.lineLength=[],f=[];b=b.bottom-b.top;var g=a.ip+c,k=0;for(c=0;c<b;++c)d[c]=A(a);for(c=0;c<b&&!(f[c]=O(a,d[c]),k+=f[c].length,a.ip>=g);++c);if(m){this.channel=new Uint8Array(k);a=c=0;for(b=f.length;c<b;++c)this.channel.set(f[c],a),a+=f[c].length}else this.channel=Array.prototype.concat.apply([],f)};function Z(){}Z.prototype.parse=function(a,b){var c=this.channel=[],d,f,g,k,h;this.offset=a.ip;f=0;for(g=b.channels;f<g;++f)if(k=a.ip,h=b.info[f],d=A(a),2!==h.length){switch(d){case 0:d=new X;break;case 1:d=new Y;break;default:throw Error("unknown compression method: "+d);}d.parse(a,b,h.length-2);c[f]=d;a.seek(h.length+k,0)}this.length=a.ip-this.offset};
Z.prototype.createCanvas=function(a,b,c){var d=document.createElement("canvas"),f=d.getContext("2d"),g=d.width=c.right-c.left,k=d.height=c.bottom-c.top,h,s,q=this.channel,x=[],t,w,y,C;if(0===g||0===k)return null;h=f.createImageData(g,k);s=h.data;t=0;for(w=q.length;t<w;++t)switch(c.info[t].id){case 0:case 1:case 2:case 3:x[c.info[t].id]=q[t].channel;break;case -1:y=q[t].channel;break;case -2:C=q[t].channel;break;default:window.console.warn("not supported channel id",c.info[t].id)}y&&x.push(y);a=new R(a,
b,x);a.parsed||a.parse();q=[a.redChannel,a.greenChannel,a.blueChannel,a.alphaChannel];for(b=0;b<k;++b)for(a=0;a<g;++a)c=b*g+a,s[4*c+0]=q[0][c],s[4*c+1]=q[1][c],s[4*c+2]=q[2][c],s[4*c+3]=C?C[c]/255*(q[3]?q[3][c]:255):q[3]?q[3][c]:255;f.putImageData(h,0,0);return d};function na(){this.layerRecord=[];this.channelImageData=[]}na.prototype.parse=function(a,b){var c,d,f;this.offset=a.ip;this.length=r(a)+4;this.layerCount=Math.abs(B(a));c=0;for(d=this.layerCount;c<d;++c)f=new ma,f.parse(a,b),this.layerRecord[c]=f;c=0;for(d=this.layerCount;c<d;++c)f=new Z,f.parse(a,this.layerRecord[c]),this.channelImageData[c]=f;a.seek(this.offset+this.length,0)};function oa(){}oa.prototype.parse=function(a,b){var c;this.offset=a.ip;c=r(a);this.length=c+4;0===c&&window.console.log("skip: layer and mask information (empty body)");c=a.ip+c;this.layerInfo=new na;this.globalLayerMaskInfo=new P;this.additionalLayerInfo=new n;this.layerInfo.parse(a,b);this.globalLayerMaskInfo.parse(a,b);this.additionalLayerInfo.parse(a,b);a.seek(c,0)};function $(a,b){b||(b={});this.stream=new M(a,b.inputPosition|0)}$.prototype.parse=function(){var a=this.stream;this.header=new Q;this.colorModeData=new S;this.imageResources=new la;this.layerAndMaskInformation=new oa;this.imageData=new V;this.header.parse(a);this.colorModeData.parse(a,this.header);this.imageResources.parse(a);this.layerAndMaskInformation.parse(a,this.header);this.imageData.parse(a,this.header)};j("PSD.Parser",$);j("PSD.Parser.prototype.parse",$.prototype.parse);}).call(this);
